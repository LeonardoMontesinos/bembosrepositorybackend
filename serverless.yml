org: bemmbos
service: bemmbos

plugins:
  - serverless-dotenv-plugin
  - serverless-openapi-documentation
  - serverless-plugin-scripts

provider:
  name: aws
  runtime: nodejs22.x
  region: us-east-1
  timeout: 29
  memorySize: 1024
  iam:
    role: arn:aws:iam::438511508379:role/LabRole

  environment:
    USER_TABLE: UserTable-${sls:stage}
    ORDERS_TABLE: OrdersTable-${sls:stage}
    ORDERS_BUCKET: restaurant-orders-dashboard-${sls:stage}
    MENU_TABLE: MenuTable-${sls:stage}
    MENU_BUCKET: menu-bucket-${sls:stage}
    JWT_SECRET: ${env:JWT_SECRET}
    ALLOWED_ORIGINS: ${env:ALLOWED_ORIGINS, '*'}
    CORS_ALLOW_CREDENTIALS: ${env:CORS_ALLOW_CREDENTIALS, 'false'}
    WS_STAGE: ${sls:stage}

package:
  include:
    - openapi.json

custom:
  documentation:
    api:
      info:
        version: "1.0.0"
        title: "Bembos API"
        description: "Documentación automática generada desde serverless.yml"
    # JSON Schema models used by the OpenAPI generator
    models:
      - name: RegisterRequest
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            email:
              type: string
            username:
              type: string
            password:
              type: string
            tenantId:
              type: string
          required: [email, password]
      - name: LoginRequest
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            email:
              type: string
            password:
              type: string
          required: [email, password]
      - name: UserResponse
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            userId: { type: string }
            username: { type: string }
            email: { type: string }
            role: { type: string }
      - name: TokenResponse
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            token: { type: string }
      - name: CreateOrderRequest
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            tenantId: { type: string }
            items:
              type: array
              items:
                type: object
                properties:
                  dishId: { type: string }
                  quantity: { type: integer }
          required: [items]
      - name: OrderResponse
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            orderId: { type: string }
            status: { type: string }
            items:
              type: array
              items:
                type: object
      - name: UpdateStatusRequest
        contentType: application/json
        schema:
          $schema: 'http://json-schema.org/draft-07/schema#'
          type: object
          properties:
            status: { type: string }
          required: [status]
  openapi:
    output: openapi.json
  scripts:
    hooks:
      # generate OpenAPI spec automatically before deploy
      before:deploy:deploy: "npx serverless openapi generate"

functions:

  register:
    handler: auth/register.handler
    documentation:
      summary: "Register user"
      description: "Crea un nuevo usuario"
      requestBody:
        description: "Datos para registro"
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
    events:
      - http:
          path: auth/register
          method: post
          cors: true

  login:
    handler: auth/login.handler
    documentation:
      summary: "Login"
      description: "Obtiene token de autenticación"
      requestBody:
        description: "Credenciales"
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
    events:
      - http:
          path: auth/login
          method: post
          cors: true

  authorizer:
    handler: authorizer.handler

  ordersCreate:
    handler: orders/index.create
    documentation:
      summary: "Create order"
      description: "Crea una nueva orden"
      requestBody:
        description: "Datos de la orden"
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
    events:
      - http:
          path: orders
          method: post
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  ordersList:
    handler: orders/index.list
    documentation:
      summary: "List orders"
      description: "Lista órdenes del tenant"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderResponse'
    events:
      - http:
          path: orders
          method: get
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  ordersGet:
    handler: orders/index.get
    documentation:
      summary: "Get order"
      description: "Obtiene una orden por id"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
    events:
      - http:
          path: orders/{id}
          method: get
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  ordersUpdateStatus:
    handler: orders/index.updateStatus
    documentation:
      summary: "Update order status"
      description: "Actualiza el estado de una orden"
      requestBody:
        description: "Nuevo estado"
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusRequest'
      responses:
        '200':
          description: OK
    events:
      - http:
          path: orders/{id}/status
          method: patch
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  adminCreateWorker:
    handler: admin/createWorker.handler
    documentation:
      summary: "Create worker"
      description: "Crea un trabajador"
    events:
      - http:
          path: admin/workers
          method: post
          cors: true
          authorizer:
              name: authorizer
              type: request
              identitySource: method.request.header.Authorization

  adminCreateMenu:
    handler: admin/createMenu.handler
    documentation:
      summary: "Create menu item"
      description: "Añade un plato al menú"
    events:
      - http:
          path: admin/menu
          method: post
          cors: true
          authorizer:
              name: authorizer
              type: request
              identitySource: method.request.header.Authorization

  adminUpdateMenu:
    handler: admin/updateMenu.handler
    documentation:
      summary: "Update menu"
      description: "Actualiza elementos del menú"
    events:
      - http:
          path: admin/menu
          method: patch
          cors: true
          authorizer:
              name: authorizer
              type: request
              identitySource: method.request.header.Authorization

  createKitchen:
    handler: kitchen/createKitchen.handler
    documentation:
      summary: "Create kitchen"
      description: "Crea una cocina"
    events:
      - http:
          path: kitchens
          method: post
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  listKitchens:
    handler: kitchen/listKitchens.handler
    documentation:
      summary: "List kitchens"
      description: "Lista cocinas disponibles"
    events:
      - http:
          path: kitchens
          method: get
          cors: true
          authorizer:
            name: authorizer
            type: request
            identitySource: method.request.header.Authorization

  getMenu:
    handler: kitchen/getMenu.handler
    documentation:
      summary: "Get menu"
      description: "Obtiene el menú público"
    events:
      - http:
          path: menu
          method: get
          cors: true
          # authorizer:
          #     name: authorizer
          #     type: request
          #     identitySource: method.request.header.Authorization

  docs:
    handler: docs/index.handler
    package:
      include:
        - openapi.json
    events:
      - http:
          path: docs
          method: get
          cors: true
      - http:
          path: openapi.json
          method: get
          cors: true

resources:
  Resources:

    UserTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USER_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: tenantId, AttributeType: S }
          - { AttributeName: userId, AttributeType: S }
          - { AttributeName: email, AttributeType: S }
          - { AttributeName: username, AttributeType: S }
          - { AttributeName: role, AttributeType: S }
        KeySchema:
          - { AttributeName: userId, KeyType: HASH }
          - { AttributeName: tenantId, KeyType: RANGE }
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - { AttributeName: email, KeyType: HASH }
              - { AttributeName: tenantId, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: UsernameIndex
            KeySchema:
              - { AttributeName: username, KeyType: HASH }
              - { AttributeName: tenantId, KeyType: RANGE }
            Projection: { ProjectionType: ALL }
          - IndexName: TenantRoleIndex
            KeySchema:
              - { AttributeName: tenantId, KeyType: HASH }
              - { AttributeName: role, KeyType: RANGE }
            Projection: { ProjectionType: ALL }

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: PK, AttributeType: S }
          - { AttributeName: SK, AttributeType: S }
        KeySchema:
          - { AttributeName: PK, KeyType: HASH }
          - { AttributeName: SK, KeyType: RANGE }

    OrdersBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.ORDERS_BUCKET}

    MenuTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.MENU_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: tenantId, AttributeType: S }
          - { AttributeName: dishId, AttributeType: S }
        KeySchema:
          - { AttributeName: tenantId, KeyType: HASH }
          - { AttributeName: dishId, KeyType: RANGE }

    MenuBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.MENU_BUCKET}

    KitchenTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: KitchenTable-${sls:stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - { AttributeName: tenantId, AttributeType: S }
          - { AttributeName: kitchenId, AttributeType: S }
        KeySchema:
          - { AttributeName: tenantId, KeyType: HASH }
          - { AttributeName: kitchenId, KeyType: RANGE }